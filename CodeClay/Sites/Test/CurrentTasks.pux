<?xml version="1.0" encoding="utf-8" ?>
<CiTable>
  <TableName>Current Tasks</TableName>
  <TableCaption>Current Tasks for Everybody</TableCaption>
  <RowKey>TaskCode</RowKey>
  <DefaultView>Grid</DefaultView>
  <CiField>
    <FieldName>TaskCode</FieldName>
    <Caption>Task</Caption>
    <Width>10</Width>
  </CiField>
  <CiMemoField>
    <FieldName>TaskDescription</FieldName>
    <Caption>Description</Caption>
    <Width>30</Width>
    <ColSpan>2</ColSpan>
  </CiMemoField>
  <CiComboField>
    <FieldName>TaskType</FieldName>
    <Caption>Task Type</Caption>
    <DropdownSQL>
      select  Description as [Task Type]
      from    tblDropdown
      where   Type = 'TaskType'
      order by Description
    </DropdownSQL>
  </CiComboField>
  <CiComboField>
    <FieldName>CustomerCode</FieldName>
    <Caption>Customer</Caption>
    <Code>CustomerCode</Code>
    <Description>Customer</Description>
    <TextFieldName>Customer</TextFieldName>
    <DropdownSQL>
      select  Customer,
              BillerContact,
              CustomerCode
      from    tblCustomers
      order by CustomerCode
    </DropdownSQL>
  </CiComboField>
  <CiComboField>
    <FieldName>Category</FieldName>
    <Caption>Category</Caption>
    <DropdownSQL>
      select  Category
      from    tblCategories
      where   CustomerCode = @CustomerCode
      order by Category
    </DropdownSQL>
  </CiComboField>
  <CiComboField>
    <FieldName>PrimaryDeveloper</FieldName>
    <Caption>Staff</Caption>
    <DropdownSQL>
      select  StaffCode as Staff
      from    tblStaff
      order by StaffCode
    </DropdownSQL>
  </CiComboField>
  <CiTextField>
    <FieldName>HoursSold</FieldName>
    <Caption>Sell (H)</Caption>
    <ColumnType>Number</ColumnType>
    <ColumnFormat>0.00</ColumnFormat>
    <ColumnBackColor>AliceBlue</ColumnBackColor>
  </CiTextField>
  <CiTextField>
    <FieldName>HoursBought</FieldName>
    <Caption>Buy (H)</Caption>
    <ColumnType>Number</ColumnType>
    <ColumnFormat>0.00</ColumnFormat>
    <ColumnBackColor>AliceBlue</ColumnBackColor>
  </CiTextField>
  <CiDateField>
    <FieldName>CompletedDate</FieldName>
    <Caption>Due Date</Caption>
    <ColumnFormat>dd/MM/yyyy</ColumnFormat>
    <ColumnBackColor>AliceBlue</ColumnBackColor>
  </CiDateField>
  <CiCheckField>
    <FieldName>FixedPrice</FieldName>
    <Caption>Fixed?</Caption>
    <ColumnBackColor>AliceBlue</ColumnBackColor>
  </CiCheckField>
  <CiTable Src="CommunicationsLog.pux">
    <TableCaption>Communications history</TableCaption>
    <CiToolBar>
      <CiMacro>
        <MacroName>Goodbye</MacroName>
        <VisibleSQL>
          select  1
          from    tblSingleton
          where   @Author = 'Adrian'
        </VisibleSQL>
        <ActionSQL>
          update  tblCommunicationsLog
          set     Comment = @Comment + ';Bye'
          where   TaskCode = @TaskCode
          and     LogID = @LogID
        </ActionSQL>
        <NavigateUrl>http://www.google.com.au</NavigateUrl>
        <NavigatePos>Popup</NavigatePos>
      </CiMacro>
    </CiToolBar>
  </CiTable>
  <CiComboField>
    <FieldName>InvoiceNumber</FieldName>
    <Caption>Invoice</Caption>
    <DropdownSQL>
      select  InvoiceNumber as [Invoice]
      from    tblInvoices
      where   DispatchDate is null
      and     CustomerCode = @CustomerCode
      order by InvoiceNumber
    </DropdownSQL>
  </CiComboField>
  <CiComboField>
    <FieldName>TaskStatus</FieldName>
    <Caption>Status</Caption>
    <ColumnBackColor>AliceBlue</ColumnBackColor>
    <DropdownSQL>
      select  Description as [Status]
      from    tblDropdown
      where   Type = 'TaskStatus'
      order by Description
    </DropdownSQL>
  </CiComboField>
  <CiCheckField>
    <FieldName>Billable</FieldName>
    <Hidden>true</Hidden>
  </CiCheckField>
  <CiTextField>
    <FieldName>SellPrice</FieldName>
    <Hidden>true</Hidden>
  </CiTextField>
  <CiTextField>
    <FieldName>BuyPrice</FieldName>
    <Hidden>true</Hidden>
  </CiTextField>
  <CiTable Src="Timings.pux">
    <TableCaption>Time itemisation</TableCaption>
    <DefaultView>Grid</DefaultView>
  </CiTable>
  <DefaultMacro>
    <ActionSQL>
      select 'T00001' as TaskCode,
             'Hello World' as TaskDescription
      from   tblSingleton
    </ActionSQL>
  </DefaultMacro>
  <SelectMacro>
    <ActionSQL>
      select  TaskCode,
              TaskDescription,
              TaskType,
              C.CustomerCode,
              C.Customer,
              Category,
              PrimaryDeveloper,
      	      HoursSold,
              FixedPrice,
              HoursBought,
	            TaskStatus,
              CompletedDate,
              InvoiceNumber,
	            T.Billable,
	            BuyPrice,
              SellPrice
      from    tblTasks T,
              tblCustomers C
      where   InvoiceNumber is null
      and     (TaskStatus &lt;&gt; "REJECT" or TaskStatus is null)
      and     (PrimaryDeveloper &lt;&gt; "TBA" or PrimaryDeveloper is null)
      and     C.CustomerCode = T.CustomerCode
      order by TaskCode
    </ActionSQL>
  </SelectMacro>
  <UpdateMacro>
    <ActionSQL>
      update  tblTasks
      set     TaskDescription    = @TaskDescription,
              TaskType           = @TaskType,
              CustomerCode       = @CustomerCode,
              Category           = @Category,
              InvoiceNumber      = @InvoiceNumber,
              PrimaryDeveloper   = @PrimaryDeveloper,
              CompletedDate      = @CompletedDate,
              FixedPrice         = @FixedPrice,
              TaskStatus         = @TaskStatus,
	            Billable		       = @Billable,
	            HoursSold	      	 = @HoursSold,
	            SellPrice     		 = @SellPrice,
	            BuyPrice      		 = @BuyPrice
      where   TaskCode           = @TaskCode
    </ActionSQL>
  </UpdateMacro>
  <InsertMacro>
    <ActionSQL>
      select  'T'+right('000000'+ trim(str(1+Right(iif(isnull(Max(Taskcode)), 'T000000', Max(Taskcode)), 6))) ,6) as TaskCode
      from    tblTasks
    </ActionSQL>
    <ActionSQL>
      insert
      into  tblTasks
      (     TaskCode,
            TaskDescription,
            TaskType,
            CustomerCode,
            Category,
            InvoiceNumber,
            PrimaryDeveloper,
            CompletedDate,
            FixedPrice,
            TaskStatus,
            Billable,
	          SellPrice,
	          BuyPrice,
	          HoursSold
      )
      values
      (     @TaskCode,
            @TaskDescription,
            @TaskType,
            @CustomerCode,
            @Category,
            @InvoiceNumber,
            @PrimaryDeveloper,
            @CompletedDate,
            @FixedPrice,
            @TaskStatus,
            @Billable,
	          0.0,
	          0.0,
	          @HoursSold
       )
    </ActionSQL>
    <ActionSQL>
	    update  tblTasks INNER JOIN tblStaff ON tblTasks.PrimaryDeveloper = tblStaff.StaffCode
	    set     SellPrice = HoursSold * tblStaff.SellHourlyRate
	    where   tblTasks.TaskCode = @TaskCode
    </ActionSQL>
    <ActionSQL>
      select  @TaskCode as TaskCode
    </ActionSQL>
  </InsertMacro>
  <DeleteMacro>
    <ActionSQL>
      delete from tblTasks where TaskCode = @TaskCode
    </ActionSQL>
  </DeleteMacro>
  <CiMacro>
    <MacroName>Start Timer</MacroName>
    <ActionSQL>
      insert
      into  tblTimings
      (     TaskCode,
      StartTime,
      EndTime,
      Staff
      )
      values
      (     @TaskCode,
      Now(),
      null,
      'Adrian'
      )
    </ActionSQL>
    <ActionSQL>
      UPDATE  tblTasks
      SET     TaskStatus = "1: In Progress"
      WHERE   @TaskStatus is null
      AND     TaskCode = @TaskCode
    </ActionSQL>
    <VisibleSQL>
      select  1
      from    tblSingleton
      where   not exists
      (       select  1
      from    tblTimings
      where   TaskCode = @TaskCode
      and     EndTime is null
      and     Staff = 'Adrian'
      )
    </VisibleSQL>
  </CiMacro>
  <CiMacro>
    <MacroName>Stop Timer</MacroName>
    <ActionSQL>
      update  tblTimings
      set     EndTime   = Now()
      where   TaskCode  = @TaskCode
      and     EndTime   is null
      and     Staff =   'Adrian'
    </ActionSQL>
    <ActionSQL>
      select BuyHourlyRate from tblStaff where StaffCode = @PrimaryDeveloper
    </ActionSQL>
    <ActionSQL>
      update  tblTasks
      set     HoursBought = DSum("BuyHour","qryHourlyCalculation","TaskCode='" + @TaskCode + "'"),
      HoursSold = iif(@FixedPrice = false,DSum("SellHour","qryHourlyCalculation","TaskCode='" + @TaskCode + "'"),HoursSold),
      SellPrice = iif(@FixedPrice = false,DSum("SellPrice","qryHourlyCalculation","TaskCode='" + @TaskCode + "'"),SellPrice),
      BuyPrice =  iif(@FixedPrice = false,DSum("BuyPrice","qryHourlyCalculation","TaskCode='" + @TaskCode + "'"),@BuyHourlyRate*HoursSold)
      WHERE   TaskCode = @TaskCode
    </ActionSQL>
    <ActionSQL>
      select  1 + iif(isnull(max(LogID)), 0, max(LogID)) as LogID
      from    tblCommunicationsLog
      where   TaskCode = @TaskCode
    </ActionSQL>
    <ActionSQL>
      insert
      into    tblCommunicationsLog
      (       LogID,
      Author,
      LogDate,
      TaskCode,
      Comment,
      AttachmentName
      )
      SELECT @LogID,
      'Adrian',
      NOW(),
      @TaskCode,
      'Timer is stopped',
      null
      FROM tblSingleton where 'Timer is stopped' is not null
    </ActionSQL>
    <VisibleSQL>
      select  1
      from    tblTimings
      where   TaskCode   = @TaskCode
      and     EndTime is null
      and     Staff = 'Adrian'
    </VisibleSQL>
  </CiMacro>
</CiTable>