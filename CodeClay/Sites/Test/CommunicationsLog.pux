<?xml version="1.0" encoding="utf-8" ?>
<CiTable>
  <TableName>Communications Log</TableName>
  <RowKey>TaskCode,LogID</RowKey>
  <DefaultView>Card</DefaultView>
  <CiField>
    <FieldName>TaskCode</FieldName>
    <Caption>Task</Caption>
    <Hidden>true</Hidden>
  </CiField>
  <CiField>
    <FieldName>LogID</FieldName>
    <Caption>Log ID</Caption>
    <Hidden>true</Hidden>
  </CiField>
  <CiDateField>
    <FieldName>LogDate</FieldName>
    <Caption>Date</Caption>
    <ColumnFormat>dd/MM/yyyy</ColumnFormat>
    <Width>10</Width>
  </CiDateField>
  <CiComboField>
    <FieldName>Author</FieldName>
    <Caption>Author</Caption>
    <DropdownSQL>
      select  StaffCode as Staff
      from    tblStaff
      order by StaffCode
    </DropdownSQL>
    <Width>10</Width>
  </CiComboField>
  <CiTextField>
    <FieldName>Comment</FieldName>
    <Caption>Comment</Caption>
    <Width>30</Width>
  </CiTextField>
  <CiLinkField>
    <FieldName>AttachmentUrl</FieldName>
    <Caption>Attachment</Caption>
    <Folder lang="sql">select 'SavedFiles\Tasks\' + @TaskCode + '\L' + trim(str(@LogID))</Folder>
    <Width>50</Width>
  </CiLinkField>
  <SelectMacro>
    <ActionSQL>
      select  TaskCode,
              LogID,
              LogDate,
              Author,
              Comment,
              AttachmentName,
              AttachmentUrl
      from    tblCommunicationsLog
      where   TaskCode = @TaskCode
      order by LogID desc
    </ActionSQL>
  </SelectMacro>
  <UpdateMacro>
    <ActionSQL>
      update  tblCommunicationsLog
      set     LogDate         = @LogDate,
              Author          = @Author,
              Comment         = @Comment,
              AttachmentName  = @AttachmentName,
              AttachmentUrl   = @AttachmentUrl
      where   LogID           = @LogID
      and     TaskCode        = @TaskCode
    </ActionSQL>
  </UpdateMacro>
  <InsertMacro>
    <ActionSQL>
      select  1 + iif(isnull(max(LogID)), 0, max(LogID)) as LogID
      from    tblCommunicationsLog
      where   TaskCode = @TaskCode
    </ActionSQL>
    <ActionSQL>
      insert
      into    tblCommunicationsLog
      (       LogID,
              Author,
              LogDate,
              TaskCode,
              Comment,
              AttachmentName,
              AttachmentUrl
      )
      values
      (       @LogID,
              @Author,
              @LogDate,
              @TaskCode,
              @Comment,
              @AttachmentName,
              @AttachmentUrl
      )
    </ActionSQL>
    <ActionSQL>
      SELECT @TaskCode as TaskCode, @LogID as LogID
    </ActionSQL>
  </InsertMacro>
  <DeleteMacro>
    <ActionSQL>
      delete from tblCommunicationsLog
      where  LogID    = @LogID
      and    TaskCode = @TaskCode
    </ActionSQL>
  </DeleteMacro>
</CiTable>